#!/bin/bash

if [[ $1 == 'ls' ]]; then
	tmux ls | grep -v -- '-[0-9]\+:'
	exit
fi

if [[ -n $TMUX ]]; then echo 'Already in tmux.'; exit 1; fi

if [[ -z $1 ]]; then
	base='main'
else
	base=$1
fi

data=$(tmux ls 2>/dev/null)

if [[ -z $(echo "$data" | grep "^$base:") ]]; then
	tmux new -s "$base"
else
	for sess in $(echo "$data" | grep "^$base-[0-9]\+:" | grep -v '(attached)' | cut -d: -f1); do
		tmux kill-session -t $sess
	done

	new=$base-$(date +%m%d%H%M%S)
	tmux new -s "$new" -t "$base" \; set -q destroy-unattached on
fi
